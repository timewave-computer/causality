# Operation

*This document provides reference information for the `Operation` data structure.*

*Last updated: 2023-09-05*

## Overview

An `Operation` represents an action that an agent performs on a resource in the Causality system. Operations encapsulate the intent of an agent, the target resource, and the parameters needed to execute the action. They are the primary mechanism for changing state in the system. As defined in ADR-032, operations are a core component of the unified system architecture and work closely with the integrated effect system.

## Type Definition

```rust
pub struct Operation {
    /// Unique identifier for the operation
    id: OperationId,
    
    /// Agent that initiated the operation
    agent_id: AgentId,
    
    /// Target resource for the operation
    target_resource: ResourceId,
    
    /// Action to perform
    action: String,
    
    /// Parameters for the action
    parameters: OperationParameters,
    
    /// Capabilities required for this operation
    required_capabilities: Vec<CapabilityType>,
    
    /// Metadata for the operation
    metadata: OperationMetadata,
}
```

## Fields

| Field | Type | Description |
|-------|------|-------------|
| `id` | `OperationId` | The unique identifier for the operation |
| `agent_id` | `AgentId` | The identifier of the agent that initiated the operation |
| `target_resource` | `ResourceId` | The identifier of the resource that is the target of the operation |
| `action` | `String` | The action to perform on the resource |
| `parameters` | `OperationParameters` | The parameters for the action |
| `required_capabilities` | `Vec<CapabilityType>` | The capabilities required to perform this operation |
| `metadata` | `OperationMetadata` | Metadata for the operation |

## Operation ID

The `OperationId` uniquely identifies an operation in the system:

```rust
pub struct OperationId {
    /// Unique identifier
    id: String,
    
    /// Timestamp when the operation was created
    timestamp: TimeStamp,
}
```

## Operation Parameters

The `OperationParameters` encapsulate the data needed to execute an operation:

```rust
pub enum OperationParameters {
    /// JSON-based parameters
    Json(serde_json::Value),
    
    /// Binary parameters
    Binary(Vec<u8>),
    
    /// Custom parameters
    Custom(Box<dyn Any>),
}
```

## Operation Result

The result of an operation execution:

```rust
pub struct OperationResult {
    /// Operation that produced this result
    operation_id: OperationId,
    
    /// Status of the operation
    status: OperationStatus,
    
    /// Result data
    data: Option<OperationResultData>,
    
    /// Error information (if status is Failed)
    error: Option<OperationError>,
    
    /// Facts generated by this operation
    facts: Vec<Fact>,
}
```

### Operation Status

The status of an operation:

```rust
pub enum OperationStatus {
    /// Operation succeeded
    Success,
    
    /// Operation failed
    Failed,
    
    /// Operation is pending
    Pending,
    
    /// Operation is in progress
    InProgress,
    
    /// Operation was rejected
    Rejected {
        /// Reason for rejection
        reason: String,
    },
}
```

## Operation Context

The context in which an operation is executed:

```rust
pub struct OperationContext {
    /// Session information
    session: AgentSession,
    
    /// Transaction context (if part of a transaction)
    transaction: Option<TransactionContext>,
    
    /// Time of execution
    timestamp: TimeStamp,
    
    /// Additional context data
    data: HashMap<String, Box<dyn Any>>,
}
```

## Creating Operations

Operations can be created using the builder pattern:

```rust
impl OperationBuilder {
    /// Create a new operation builder
    pub fn new() -> Self;
    
    /// Set the target resource
    pub fn target_resource<T: Into<ResourceId>>(self, resource_id: T) -> Self;
    
    /// Set the action
    pub fn action<T: Into<String>>(self, action: T) -> Self;
    
    /// Set the parameters
    pub fn parameters<T: Serialize>(self, params: T) -> Result<Self, OperationError>;
    
    /// Add a required capability
    pub fn require_capability(self, capability_type: CapabilityType) -> Self;
    
    /// Build the operation
    pub fn build(self) -> Result<Operation, OperationError>;
}
```

## Executing Operations

Operations are executed by agents:

```rust
impl Agent {
    /// Execute an operation
    pub fn execute(&self, operation: Operation, context: OperationContext) 
        -> Result<OperationResult, OperationError>;
}
```

Internally, operations are executed using effects. As per ADR-032, effects are now integrated directly into the core crate:

```rust
impl Agent {
    fn execute_operation(&self, operation: Operation, context: OperationContext) 
        -> impl Effectful<OperationResult, ResourceEffect + CapabilityEffect> 
    {
        Effectful::new(move |ctx| {
            // Verify capabilities
            for cap_type in &operation.required_capabilities {
                ctx.perform(VerifyCapability { 
                    capability: self.find_capability(*cap_type, &operation.target_resource)?,
                    resource_id: operation.target_resource.clone(),
                })?;
            }
            
            // Get the resource
            let resource_guard = ctx.perform(GetResource { 
                id: operation.target_resource.clone(), 
                lock_mode: LockMode::Write 
            })?;
            
            // Execute the action
            let result = resource_guard.execute_action(
                &operation.action, 
                &operation.parameters
            )?;
            
            // Generate facts
            let facts = ctx.perform(GenerateFacts { 
                operation: operation.clone(),
                result: result.clone(),
            })?;
            
            // Create the operation result
            Ok(OperationResult {
                operation_id: operation.id,
                status: OperationStatus::Success,
                data: Some(result),
                error: None,
                facts,
            })
        })
    }
}
```

## Operation Scheduling

Operations can be scheduled for future execution:

```rust
impl Agent {
    /// Schedule an operation for future execution
    pub fn schedule_operation(
        &self, 
        operation: Operation, 
        schedule: OperationSchedule
    ) -> Result<OperationId, OperationError>;
}
```

The `OperationSchedule` defines when an operation should be executed:

```rust
pub enum OperationSchedule {
    /// Execute at a specific time
    At(TimeStamp),
    
    /// Execute after a specific time
    After(TimeStamp),
    
    /// Execute when a specific condition is met
    When(Box<dyn Fn() -> bool>),
    
    /// Execute when a specific event occurs
    OnEvent(EventFilter),
}
```

## Transaction Integration

Operations can be part of transactions:

```rust
impl Transaction {
    /// Add an operation to the transaction
    pub fn add_operation(&mut self, operation: Operation) -> Result<(), TransactionError>;
    
    /// Execute all operations in the transaction
    pub fn execute(&self, context: OperationContext) -> Result<Vec<OperationResult>, TransactionError>;
}
```

## Effect Generation

Operations can generate effects that are executed by the effect system:

```rust
impl Operation {
    /// Convert this operation to an effectful computation
    pub fn to_effectful(&self) 
        -> impl Effectful<OperationResult, ResourceEffect + CapabilityEffect> 
    {
        Effectful::new(move |ctx| {
            // Generate effects based on the operation
            let effects = self.generate_effects()?;
            
            // Execute the effects
            let results = effects.iter().map(|effect| {
                ctx.perform(effect.clone())
            }).collect::<Result<Vec<_>, _>>()?;
            
            // Create the operation result
            Ok(OperationResult {
                operation_id: self.id.clone(),
                status: OperationStatus::Success,
                data: Some(results.into()),
                error: None,
                facts: vec![],
            })
        })
    }
}
```

## Usage Example

```rust
use causality_agent::{
    agent::{Agent, AgentManager},
    operation::{Operation, OperationBuilder, OperationContext},
};
use causality_core::{
    resource::{ResourceId, ResourceManager},
    effect::{EffectSystem, Effectful},
};

// Create a resource manager
let resource_manager = ResourceManager::new();

// Create an agent manager
let agent_manager = AgentManager::new(&resource_manager);

// Create an effect system
let effect_system = EffectSystem::new();

// Create a resource ID
let database_id = ResourceId::new("database", domain_id, "customer_db")?;

// Get an agent
let alice = agent_manager.get("alice")?;

// Create an operation
let operation = OperationBuilder::new()
    .target_resource(database_id)
    .action("query")
    .parameters(json!({ "query": "SELECT * FROM customers" }))
    .require_capability(CapabilityType::Read)
    .build()?;

// Create an operation context
let context = OperationContext::new(alice.session())?;

// Execute the operation
let result = effect_system.execute(
    alice.execute(operation, context),
    EffectContext::new()
)?;

// Process the result
match result.status {
    OperationStatus::Success => {
        let data = result.data.unwrap();
        println!("Query results: {:?}", data);
    },
    OperationStatus::Failed => {
        let error = result.error.unwrap();
        println!("Operation failed: {}", error);
    },
    _ => println!("Operation status: {:?}", result.status),
}
```

## References

- [ADR-032: Agent-Based Resource System](../../../spec/adr_032_consolidated_agent_resource_system.md)
- [System Contract](../../../spec/system_contract.md)
- [Causality Agent Library](../../reference/libraries/causality-agent.md) 